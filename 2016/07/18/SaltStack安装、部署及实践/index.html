<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="SaltStack," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="安装Run the following commands to install the SaltStack repository and key:RedHat/Centos6:1yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el6.noarch.rpm
RedHat/Centos7:1yum install">
<meta property="og:type" content="article">
<meta property="og:title" content="SaltStack安装、部署及实践">
<meta property="og:url" content="http://charles.pub/2016/07/18/SaltStack安装、部署及实践/index.html">
<meta property="og:site_name" content="“运维 - 架构”">
<meta property="og:description" content="安装Run the following commands to install the SaltStack repository and key:RedHat/Centos6:1yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el6.noarch.rpm
RedHat/Centos7:1yum install">
<meta property="og:updated_time" content="2017-05-24T05:46:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SaltStack安装、部署及实践">
<meta name="twitter:description" content="安装Run the following commands to install the SaltStack repository and key:RedHat/Centos6:1yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el6.noarch.rpm
RedHat/Centos7:1yum install">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'U8RQYDSHQE',
      apiKey: '4e3ee6017aa53b87273a8f9c07c6fad8',
      indexName: 'BlogIndex',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://charles.pub/2016/07/18/SaltStack安装、部署及实践/"/>





  <title> SaltStack安装、部署及实践 | “运维 - 架构” </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b71d9b907f3535ada947168b45eb247b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">“运维 - 架构”</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://charles.pub/2016/07/18/SaltStack安装、部署及实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qingyu.li">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="“运维 - 架构”">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                SaltStack安装、部署及实践
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-18T16:19:16+08:00">
                2016-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/07/18/SaltStack安装、部署及实践/" class="leancloud_visitors" data-flag-title="SaltStack安装、部署及实践">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="Run-the-following-commands-to-install-the-SaltStack-repository-and-key"><a href="#Run-the-following-commands-to-install-the-SaltStack-repository-and-key" class="headerlink" title="Run the following commands to install the SaltStack repository and key:"></a>Run the following commands to install the SaltStack repository and key:</h2><h3 id="RedHat-Centos6"><a href="#RedHat-Centos6" class="headerlink" title="RedHat/Centos6:"></a>RedHat/Centos6:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el6.noarch.rpm</div></pre></td></tr></table></figure>
<h3 id="RedHat-Centos7"><a href="#RedHat-Centos7" class="headerlink" title="RedHat/Centos7:"></a>RedHat/Centos7:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el7.noarch.rpm</div></pre></td></tr></table></figure>
<h2 id="Run-yum-clean-expire-cache"><a href="#Run-yum-clean-expire-cache" class="headerlink" title="Run yum clean expire-cache"></a>Run <code>yum clean expire-cache</code></h2><h2 id="Install-the-salt-minion-salt-master-or-other-Salt-components"><a href="#Install-the-salt-minion-salt-master-or-other-Salt-components" class="headerlink" title="Install the salt-minion, salt-master, or other Salt components:"></a>Install the salt-minion, salt-master, or other Salt components:</h2><ul>
<li><code>yum install salt-master</code></li>
<li><code>yum install salt-minion</code></li>
<li><code>yum install salt-ssh</code></li>
<li><code>yum install salt-syndic</code></li>
<li><code>yum install salt-cloud</code></li>
<li><code>yum install salt-api</code></li>
</ul>
<h2 id="Automatically-start"><a href="#Automatically-start" class="headerlink" title="Automatically start"></a>Automatically start</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chkconfig salt-master on</div><div class="line">chkconfig salt-minion on</div></pre></td></tr></table></figure>
<h2 id="其他安装方式：salt-bootstrap-项目，多平台一键部署SaltStack环境"><a href="#其他安装方式：salt-bootstrap-项目，多平台一键部署SaltStack环境" class="headerlink" title="其他安装方式：salt-bootstrap 项目，多平台一键部署SaltStack环境"></a>其他安装方式：salt-bootstrap 项目，多平台一键部署SaltStack环境</h2><h3 id="Master端安装："><a href="#Master端安装：" class="headerlink" title="Master端安装："></a>Master端安装：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -L https://bootstrap.saltstack.com -o install_salt.sh</div><div class="line">sh install_salt.sh -P -M # 如果不需要安装Minion，只安装master，需要加上&quot;-N&quot;参数</div><div class="line"># sh install_salt.sh -h 查看可用脚本参数</div></pre></td></tr></table></figure>
<h3 id="Minion端安装："><a href="#Minion端安装：" class="headerlink" title="Minion端安装："></a>Minion端安装：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">echo &quot;IPADDRESS salt&quot; &gt;&gt; /etc/hosts # IPADDRESS为Master服务器地址</div><div class="line">curl -L https://bootstrap.saltstack.com -o install_salt.sh</div><div class="line">sh install_salt.sh -P -i Minion # 只安装最新版Minion并指定ID为&quot;Minion&quot;</div></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="minion配置修改"><a href="#minion配置修改" class="headerlink" title="minion配置修改"></a>minion配置修改</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sed -i &apos;s/#master: salt/master: IPADDRESS/g&apos; /etc/salt/minion  #IPADDRESS为Master服务器地址</div><div class="line">sed -i &apos;s/#id:/id: ID/g&apos; /etc/salt/minion  #ID为自定义客户端ID号，可用客户端IP地址</div><div class="line">service salt-master start</div><div class="line">service salt-minion start</div></pre></td></tr></table></figure>
<h2 id="master服务端查看证书签证情况，并同意没有接受的签证请求"><a href="#master服务端查看证书签证情况，并同意没有接受的签证请求" class="headerlink" title="master服务端查看证书签证情况，并同意没有接受的签证请求"></a>master服务端查看证书签证情况，并同意没有接受的签证请求</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">salt-key -L</div><div class="line">salt-key -A -y</div><div class="line"># 更多的证书管理命令，可运行salt-key -h查看</div></pre></td></tr></table></figure>
<h2 id="执行第一条SaltStack命令"><a href="#执行第一条SaltStack命令" class="headerlink" title="执行第一条SaltStack命令"></a>执行第一条SaltStack命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;ID&apos; test.ping # ID 为客户端ID，或者其他角色定义</div></pre></td></tr></table></figure>
<h2 id="一些常用命令"><a href="#一些常用命令" class="headerlink" title="一些常用命令"></a>一些常用命令</h2><a id="more"></a>
<h3 id="匹配方式"><a href="#匹配方式" class="headerlink" title="匹配方式"></a>匹配方式</h3><ul>
<li>正则匹配 <code>salt -E &#39;Min*&#39; test.ping</code></li>
<li>列表匹配 <code>salt -L Minion,Minion1 test.ping</code></li>
<li>Grains匹配 <code>salt -G &#39;os:Centos&#39; test.ping</code></li>
<li><p>组匹配 <code>salt -N groups test.ping</code><br>在Saltstack系统中可以提前给Minion定义组角色，但是需要知道Minion的ID信息。groups是在master配置中定义的组名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nodegroups:</div><div class="line">  groups: &apos;L@node1,node2&apos;</div></pre></td></tr></table></figure>
</li>
<li><p>复合匹配 <code>salt -C &#39;G@os:Centos and L@node1&#39; test.ping</code></p>
</li>
<li>Pillar值匹配 <code>salt -I &#39;key:value&#39; test.ping</code></li>
<li>CIDR匹配 <code>salt -S &#39;192.168.56.0/24&#39; test.ping</code>  # 指定一个CIDR网段，是Minion连接Master4505端口的来源地址。</li>
</ul>
<h3 id="Grains"><a href="#Grains" class="headerlink" title="Grains"></a>Grains</h3><ul>
<li>列出Grains相关命令的用法 <code>salt &#39;node1&#39; sys.list_functions grains</code></li>
<li><p>通过Minion配置文件定义Grains，为了统一管理Minion的信息，建立独立的配置文件，修改后<strong>须重启Minion服务</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 文件路径 /etc/salt/minion.d/grains.conf</div><div class="line">grains:</div><div class="line">  roles:</div><div class="line">    - webserver</div><div class="line">    - memcache</div><div class="line">  deployment: datacenter</div></pre></td></tr></table></figure>
</li>
<li><p>查看定义的Grain信息 <code>salt node1 grains.item roles</code></p>
</li>
<li>结合匹配 <code>salt -G &#39;roles:webserver&#39; test.ping</code></li>
</ul>
<h3 id="Pillar"><a href="#Pillar" class="headerlink" title="Pillar"></a>Pillar</h3><ul>
<li>列出Pillar相关命令的用法 <code>salt &#39;node1&#39; sys.list_functions pillar</code></li>
<li>详细用法与例子可以用过命令<code>salt &#39;node1&#39; sys.doc pillar</code>查看</li>
</ul>
<h3 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h3><ul>
<li>查看Minion支持的所有module列表 <code>salt &#39;node1&#39; sys.list_modules</code></li>
<li>查看指定module的所有functions <code>salt &#39;node1&#39; sys.list_functions cmd</code></li>
<li>查看指定module的用法 <code>salt &#39;node1&#39; sys.doc cmd</code></li>
</ul>
<h3 id="States"><a href="#States" class="headerlink" title="States"></a>States</h3><ul>
<li>查看Minion支持的所有states列表 <code>salt &#39;node1&#39; sys.list_state_modules</code></li>
<li>查看指定states的所有functions <code>salt &#39;node1&#39; sys.list_state_functions cmd</code></li>
<li>查看指定states的用法 <code>salt &#39;node1&#39; sys.state_doc cmd</code></li>
<li>查看指定states指定function的用法 <code>salt &#39;node1&#39; sys.state_doc cmd.run</code></li>
</ul>
<h1 id="实践案例"><a href="#实践案例" class="headerlink" title="实践案例"></a>实践案例</h1><h2 id="环境规划"><a href="#环境规划" class="headerlink" title="环境规划"></a>环境规划</h2><table>
<thead>
<tr>
<th style="text-align:center">主机名</th>
<th style="text-align:center">IP地址</th>
<th style="text-align:center">角色</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">master</td>
<td style="text-align:center">10.0.0.7</td>
<td style="text-align:center">master</td>
</tr>
<tr>
<td style="text-align:center">node1</td>
<td style="text-align:center">192.168.56.11</td>
<td style="text-align:center">Minion,Haproxy+Keepalived,<br>Nginx+PHP</td>
</tr>
<tr>
<td style="text-align:center">node2</td>
<td style="text-align:center">10.0.0.8</td>
<td style="text-align:center">Minion,Memcached,Haproxy+<br>Keepalived,Nginx+PHP</td>
</tr>
</tbody>
</table>
<h3 id="SaltStack环境设置"><a href="#SaltStack环境设置" class="headerlink" title="SaltStack环境设置"></a>SaltStack环境设置</h3><p>本案例使用两个环境base和prod, base环境用来存放初始化的功能。prod环境用于放置生产的配置管理功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># vim /etc/salt/master</span></div><div class="line"></div><div class="line"><span class="comment"># File Server settings</span></div><div class="line">file_roots:</div><div class="line">  base:</div><div class="line">    - /srv/salt/base</div><div class="line">  prod:</div><div class="line">    - /srv/salt/prod</div><div class="line"></div><div class="line"><span class="comment"># Pillar settings</span></div><div class="line">pillar_roots:</div><div class="line">  base:</div><div class="line">    - /srv/pillar/base</div><div class="line">    - /srv/pillar/prod</div></pre></td></tr></table></figure>
<p>创建目录结构并重启salt-master:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># mkdir -p /srv/salt/&#123;base,prod&#125;</span></div><div class="line">[root@master ~]<span class="comment"># mkdir -p /srv/pillar/&#123;base,prod&#125;</span></div><div class="line">[root@master ~]<span class="comment"># /etc/init.d/salt-master restart</span></div></pre></td></tr></table></figure>
<h2 id="YAML-编写技巧"><a href="#YAML-编写技巧" class="headerlink" title="YAML 编写技巧"></a>YAML 编写技巧</h2><h3 id="什么是YAML"><a href="#什么是YAML" class="headerlink" title="什么是YAML"></a>什么是YAML</h3><blockquote>
<p>YAML 是”YAML Ain’t a Markup Language”（YAML不是一种置标语言）的递归缩写。<br>YAML 的语法很简单，结构通过空格来展示，项目使用”-“来代表，键值对用”:”分割。</p>
</blockquote>
<h3 id="规则："><a href="#规则：" class="headerlink" title="规则："></a>规则：</h3><ul>
<li>缩进：YAML使用一个固定的缩进风格表示数据层级结构关系。在缩排中空白字符的数目并不是非常重要，只要相同阶层的元素左侧对齐就可以了，个人习惯约定每个缩进级别为两个空格。</li>
<li>冒号： Key: Value 的键值对，value 可以通过缩进与key连接。</li>
<li>横短杠： 表示列表项，一个短横杠加一个空格。通过缩进级别控制同一列表。列表可以作为一个键值对的value，这在SaltStack中很常见。</li>
</ul>
<h2 id="Jinja-使用技巧"><a href="#Jinja-使用技巧" class="headerlink" title="Jinja 使用技巧"></a>Jinja 使用技巧</h2><h3 id="什么是-Jinja"><a href="#什么是-Jinja" class="headerlink" title="什么是 Jinja"></a>什么是 Jinja</h3><blockquote>
<ul>
<li>Jinja2是Python下一个被广泛应用的模版引擎，他的设计思想来源于Django的模板引擎，并扩展了其语法和一系列强大的功能。其中最显著的一个是增加了沙箱执行功能和可选的自动转义功能，这对大多应用的安全性来说是非常重要的。</li>
<li>他基于unicode并能在python2.4之后的版本运行，包括python3。</li>
</ul>
</blockquote>
<h3 id="如何区分模版文件"><a href="#如何区分模版文件" class="headerlink" title="如何区分模版文件"></a>如何区分模版文件</h3><p>在 SaltStack 中， files 和 templates 都使用 file 这个 states 模块。通过使用 template 指令指定类型来区分是模版还是普通文件。</p>
<h3 id="Jinja-基本使用"><a href="#Jinja-基本使用" class="headerlink" title="Jinja 基本使用"></a>Jinja 基本使用</h3><ul>
<li>File 状态使用 template 参数 - template: jinja</li>
<li>模版文件里面变量使用  , 比如 </li>
<li><p>File 状态模块要指定变量列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- defaults:</div><div class="line">PORT: 8080</div></pre></td></tr></table></figure>
</li>
<li><p>Jinja 变量使用Grains:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; grains[&apos;fqdn_ipv4&apos;] &#125;&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Jinja 变量使用执行模块：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; salt[&apos;network.hw_addr&apos;](&apos;eth0&apos;) &#125;&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Jinja 变量使用Pillar：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; pillar[&apos;apache&apos;][&apos;PORT&apos;] &#125;&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Jinja-逻辑关系"><a href="#Jinja-逻辑关系" class="headerlink" title="Jinja 逻辑关系"></a>Jinja 逻辑关系</h3><p>Jinja还主要来给状态增加逻辑关系，例如使用Grains来判断服务器的操作系统：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;% if grains[&apos;os&apos;] == &apos;RedHat&apos; %&#125;</div><div class="line">apache: httpd</div><div class="line">&#123;% elif grains[&apos;os&apos;] == &apos;Debian&apos; %&#125;</div><div class="line">apache: apache2</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<h2 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h2><p>在 Base 环境下创建 Init 目录，将系统初始化配置的SLS均放置到此目录下，称为“初始化模版”。</p>
<h3 id="DNS-配置"><a href="#DNS-配置" class="headerlink" title="DNS 配置"></a>DNS 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># vim /srv/salt/base/init/dns.sls</span></div><div class="line">/etc/resolv.conf:</div><div class="line">  file.managed:</div><div class="line">    - <span class="built_in">source</span>: salt://init/files/resolv.conf</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - mode: 644</div></pre></td></tr></table></figure>
<h3 id="Histroy-记录时间-操作记录加入到系统-message-日志"><a href="#Histroy-记录时间-操作记录加入到系统-message-日志" class="headerlink" title="Histroy 记录时间, 操作记录加入到系统 message 日志"></a>Histroy 记录时间, 操作记录加入到系统 message 日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/salt/base/init/histroy.sls</span></div><div class="line">/etc/profile:</div><div class="line">  file.append:</div><div class="line">    - text:</div><div class="line">        - <span class="built_in">export</span> HISTTIMEFORMAT=<span class="string">"%F %T `whoami` "</span></div></pre></td></tr></table></figure>
<h3 id="命令操作审计"><a href="#命令操作审计" class="headerlink" title="命令操作审计"></a>命令操作审计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/salt/base/init/audit.sls</span></div><div class="line">/etc/bashrc:</div><div class="line">  file.append:</div><div class="line">    - text:</div><div class="line">        - <span class="built_in">export</span> PROMPT_COMMAND=<span class="string">'&#123; msg=$(history 1 |  &#123; read x y; echo $y; &#125;);logger "[euid=$(whoami)]":$(who am i):[`pwd`]:"$msg"; &#125;'</span></div></pre></td></tr></table></figure>
<h3 id="内核参数优化"><a href="#内核参数优化" class="headerlink" title="内核参数优化"></a>内核参数优化</h3><p>SaltStack 提供了 Sysctl 状态模块用来进行内核参数的配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/salt/base/init/sysctl.sls</span></div><div class="line"><span class="comment"># 外向syn握手重试次数，默认4</span></div><div class="line">net.ipv4.tcp_syn_retries:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1</div><div class="line"></div><div class="line"><span class="comment"># syn-ack握手状态重试次数，默认5，遭受syn-flood攻击时改为1或2</span></div><div class="line">net.ipv4.tcp_synack_retries:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1</div><div class="line"></div><div class="line"><span class="comment"># 当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时，改为10分钟。</span></div><div class="line">net.ipv4.tcp_keepalive_time:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 600</div><div class="line"></div><div class="line"><span class="comment"># 在认定连接失效之前，发送多少个TCP的keepalive探测包。缺省值是9。</span></div><div class="line">net.ipv4.tcp_keepalive_probes:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 3</div><div class="line"></div><div class="line"><span class="comment"># 当探测没有确认时，重新发送探测的频度。缺省是75秒。</span></div><div class="line">net.ipv4.tcp_keepalive_intvl:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 15</div><div class="line"></div><div class="line"><span class="comment"># 活动TCP连接重传次数,超过次数视为掉线,放弃连接。缺省值:15。</span></div><div class="line">net.ipv4.tcp_retries2:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 5</div><div class="line"></div><div class="line"><span class="comment"># 设置保持在FIN_WAIT_2状态的时间。</span></div><div class="line">net.ipv4.tcp_fin_timeout:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 2</div><div class="line"></div><div class="line"><span class="comment"># 系统同时保持TIME_WAIT的最大数量。</span></div><div class="line">net.ipv4.tcp_max_tw_buckets:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 36000</div><div class="line"></div><div class="line"><span class="comment"># 开启TCP连接中TIME-WAIT sockets的快速回收。</span></div><div class="line">net.ipv4.tcp_tw_recycle:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1</div><div class="line"></div><div class="line"><span class="comment"># 开启重用。</span></div><div class="line">net.ipv4.tcp_tw_reuse:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1</div><div class="line"></div><div class="line"><span class="comment"># 最大孤儿套接字(orphan sockets)数。</span></div><div class="line">net.ipv4.tcp_max_orphans:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 32768</div><div class="line"></div><div class="line"><span class="comment"># 开启SYN Cookies。</span></div><div class="line">net.ipv4.tcp_syncookies:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1</div><div class="line"></div><div class="line"><span class="comment"># 增加TCP SYN队列长度，使系统可以处理更多的并发连接。</span></div><div class="line">net.ipv4.tcp_max_syn_backlog:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 16384</div><div class="line"></div><div class="line"><span class="comment"># TCP写buffer。</span></div><div class="line">net.ipv4.tcp_wmem:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 8192 131072 16777216</div><div class="line"></div><div class="line"><span class="comment"># TCP读buffer。</span></div><div class="line">net.ipv4.tcp_rmem:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 32768 131072 16777216</div><div class="line"></div><div class="line"><span class="comment"># 内核分配给TCP连接的内存，大于8G以上内存机器采用以下数值。</span></div><div class="line">net.ipv4.tcp_mem:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 786432 1048576 1572864</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 设置TCP可用的端口范围。</span></div><div class="line">net.ipv4.ip_local_port_range:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1024 65000</div><div class="line"></div><div class="line"><span class="comment"># socket监听(listen)的backlog上限。</span></div><div class="line">net.core.somaxconn:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 16384</div><div class="line"></div><div class="line">net.core.netdev_max_backlog:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 16384</div><div class="line"></div><div class="line"><span class="comment"># 设置可以打开的最大文件数。</span></div><div class="line">fs.file-max:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 2000000</div><div class="line"></div><div class="line"><span class="comment"># 开启IP转发。</span></div><div class="line">net.ipv4.ip_forward:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1</div></pre></td></tr></table></figure>
<h3 id="epel-仓库"><a href="#epel-仓库" class="headerlink" title="epel 仓库"></a>epel 仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/salt/base/init/epel.sls</span></div><div class="line">yum_repo_release_6:</div><div class="line">  pkg.installed:</div><div class="line">    - sources:</div><div class="line">        - epel-release: http://mirrors.aliyun.com/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line">        - zabbix-release: http://mirrors.aliyun.com/zabbix/zabbix/3.0/rhel/6/x86_64/zabbix-release-3.0-1.el6.noarch.rpm</div><div class="line">    - unless:</div><div class="line">        - cat /etc/redhat-release | grep -vw <span class="string">'release 6'</span></div><div class="line"></div><div class="line">yum_repo_release_7:</div><div class="line">  pkg.installed:</div><div class="line">    - sources:</div><div class="line">        - epel-release: http://mirrors.aliyun.com/epel/7/x86_64/e/epel-release-7-9.noarch.rpm</div><div class="line">        - zabbix-release: http://mirrors.aliyun.com/zabbix/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</div><div class="line">    - unless:</div><div class="line">        - cat /etc/redhat-release | grep -vw <span class="string">'release 7'</span></div></pre></td></tr></table></figure>
<h3 id="Zabbix-Agent"><a href="#Zabbix-Agent" class="headerlink" title="Zabbix Agent"></a>Zabbix Agent</h3><p>通过 Pillar 来设置 Zabbix Server 的 IP 地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/pillar/base/top.sls</span></div><div class="line">base:</div><div class="line">  <span class="string">'*'</span>:</div><div class="line">    - zabbix</div><div class="line"></div><div class="line"></div><div class="line">   </div><div class="line">[root@master init]<span class="comment"># vim /srv/pillar/base/zabbix.sls</span></div><div class="line">zabbix-agent:</div><div class="line">  zabbix_server: 10.0.0.7</div></pre></td></tr></table></figure>
<p>安装并启动 Zabbix Agent ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/salt/base/init/zabbix_agent.sls</span></div><div class="line">zabbix-agent:</div><div class="line">  pkg.installed:</div><div class="line">    - name: zabbix-agent</div><div class="line"></div><div class="line">  file.managed:</div><div class="line">    - name: /etc/zabbix/zabbix_agentd.conf</div><div class="line">    - <span class="built_in">source</span>: salt://init/files/zabbix_agentd.conf</div><div class="line">    - template: jinja</div><div class="line">    - defaults:</div><div class="line">        Server: &#123;&#123; pillar[<span class="string">'zabbix-agent'</span>][<span class="string">'zabbix_server'</span>] &#125;&#125;</div><div class="line">        Hostname: &#123;&#123; grains[<span class="string">'ip4_interfaces'</span>][<span class="string">'eth0'</span>][0] &#125;&#125;</div><div class="line"></div><div class="line">  service.running:</div><div class="line">    - <span class="built_in">enable</span>: True</div><div class="line">    - watch:</div><div class="line">        - pkg: zabbix-agent</div><div class="line">        - file: zabbix-agent</div><div class="line"></div><div class="line"><span class="comment"># Zabbix 配置文件目录，用来存放自定义的配置：</span></div><div class="line">zabbix_agent.conf.d:</div><div class="line">  file.directory:</div><div class="line">    - name: /etc/zabbix/zabbix_agentd.d</div><div class="line">    - watch_in:</div><div class="line">      - service: zabbix-agent</div><div class="line">    - require:</div><div class="line">      - pkg: zabbix-agent</div><div class="line">      - file: zabbix-agent</div></pre></td></tr></table></figure>
<p>将 zabbix_agentd.conf 文件放置 /srv/salt/base/init/files/ 目录下，同时修改对应设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Server=&#123;&#123; Server &#125;&#125;</div><div class="line">Hostname=&#123;&#123; Hostname &#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="初始化环境引用"><a href="#初始化环境引用" class="headerlink" title="初始化环境引用"></a>初始化环境引用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/salt/base/init/env_init.sls</span></div><div class="line">include:</div><div class="line">  - init.dns</div><div class="line">  - init.histroy</div><div class="line">  - init.audit</div><div class="line">  - init.sysctl</div><div class="line">  - init.epel</div><div class="line">  - init.zabbix_agent</div></pre></td></tr></table></figure>
<p>结构目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># tree /srv/salt/base/      </span></div><div class="line">/srv/salt/base/</div><div class="line">├── init</div><div class="line">│   ├── audit.sls</div><div class="line">│   ├── dns.sls</div><div class="line">│   ├── env_init.sls</div><div class="line">│   ├── epel.sls</div><div class="line">│   ├── files</div><div class="line">│   │   ├── resolv.conf</div><div class="line">│   │   └── zabbix_agentd.conf</div><div class="line">│   ├── histroy.sls</div><div class="line">│   ├── sysctl.sls</div><div class="line">│   └── zabbix_agent.sls</div><div class="line">└── top.sls</div></pre></td></tr></table></figure>
<p>在 top.sls 里面给 Minion 指定状态执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># vim /srv/salt/base/top.sls</span></div><div class="line">base:</div><div class="line">  <span class="string">'*'</span>:</div><div class="line">    - init.env_init</div></pre></td></tr></table></figure>
<p>注意，在生产环境，每次正式执行前，必须执行测试，确定 SaltStack 会执行哪些操作后再应用到服务器上:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master init]<span class="comment"># salt '*' state.highstate test=true</span></div><div class="line">[root@master init]<span class="comment"># salt '*' state.highstate</span></div></pre></td></tr></table></figure>
<h2 id="Haproxy-配置管理"><a href="#Haproxy-配置管理" class="headerlink" title="Haproxy 配置管理"></a>Haproxy 配置管理</h2><p>创建目录结构:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># mkdir -p /srv/salt/prod/pkg -p</span></div><div class="line">[root@master ~]<span class="comment"># mkdir -p /srv/salt/prod/&#123;haproxy,keepalived&#125;/files</span></div></pre></td></tr></table></figure>
<h3 id="pkg-配置"><a href="#pkg-配置" class="headerlink" title="pkg 配置"></a>pkg 配置</h3><p>使用pkg模块安装依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@master prod]<span class="comment"># vim /srv/salt/prod/pkg/pkg-init.sls</span></div><div class="line">pkg-init:</div><div class="line">  pkg.installed:</div><div class="line">    - names:</div><div class="line">      - gcc</div><div class="line">      - gcc-c++</div><div class="line">      - glibc</div><div class="line">      - make</div><div class="line">      - autoconf</div><div class="line">      - openssl</div><div class="line">      - openssl-devel</div></pre></td></tr></table></figure>
<h3 id="Haproxy-服务配置"><a href="#Haproxy-服务配置" class="headerlink" title="Haproxy 服务配置"></a>Haproxy 服务配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /usr/local/src</span></div><div class="line"><span class="comment"># wget http://www.haproxy.org/download/1.7/src/haproxy-1.7.3.tar.gz</span></div><div class="line"><span class="comment"># cp haproxy-1.7.3.tar.gz /srv/salt/prod/haproxy/files/</span></div><div class="line"><span class="comment"># tar xf haproxy-1.7.3.tar.gz</span></div><div class="line"><span class="comment"># cd /usr/local/src/haproxy-1.7.3/examples/</span></div><div class="line"><span class="comment"># sed -i 's#/usr/sbin/\$BASENAME#/usr/local/haproxy/sbin/\$BASENAME#g' haproxy.init</span></div><div class="line"><span class="comment"># cp haproxy.init /srv/salt/prod/haproxy/files/</span></div></pre></td></tr></table></figure>
<h3 id="Haproxy-的安装-SLS"><a href="#Haproxy-的安装-SLS" class="headerlink" title="Haproxy 的安装 SLS"></a>Haproxy 的安装 SLS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">[root@master examples]<span class="comment"># vim /srv/salt/prod/haproxy/install.sls</span></div><div class="line">include:</div><div class="line">  - pkg.pkg-init</div><div class="line"></div><div class="line">haproxy-install:</div><div class="line">  file.managed:</div><div class="line">    - name: /usr/<span class="built_in">local</span>/src/haproxy-1.7.3.tar.gz</div><div class="line">    - <span class="built_in">source</span>: salt://haproxy/files/haproxy-1.7.3.tar.gz</div><div class="line">    - mode: 755</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">  cmd.run:</div><div class="line">    - name: <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src &amp;&amp; tar xf haproxy-1.7.3.tar.gz &amp;&amp; <span class="built_in">cd</span> haproxy-1.7.3 &amp;&amp; make TARGET=linux26 PREFIX=/usr/<span class="built_in">local</span>/haproxy &amp;&amp; make</div><div class="line"> install PREFIX=/usr/<span class="built_in">local</span>/haproxy</div><div class="line">    - unless: <span class="built_in">test</span> <span class="_">-d</span> /usr/<span class="built_in">local</span>/haproxy</div><div class="line">    - require:</div><div class="line">        - pkg: pkg-init</div><div class="line">        - file: haproxy-install</div><div class="line"></div><div class="line"><span class="comment"># Haproxy启动脚本</span></div><div class="line">/etc/init.d/haproxy:</div><div class="line">  file.managed:</div><div class="line">    - <span class="built_in">source</span>: salt://haproxy/files/haproxy.init</div><div class="line">    - mode: 755</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - require:</div><div class="line">        - cmd: haproxy-install</div><div class="line"></div><div class="line"><span class="comment"># 设置可以监听非本地IP：</span></div><div class="line">net.ipv4.ip_nonlocal_bind:</div><div class="line">  sysctl.present:</div><div class="line">    - value: 1</div><div class="line"></div><div class="line"><span class="comment"># Haproxy的配置文件存放目录：</span></div><div class="line">haproxy-config-dir:</div><div class="line">  file.directory:</div><div class="line">    - name: /etc/haproxy</div><div class="line">    - mode: 755</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - require:</div><div class="line">        - cmd: haproxy-install</div><div class="line"></div><div class="line"><span class="comment"># 将Haproxy加入到系统服务中：</span></div><div class="line">haproxy-init:</div><div class="line">  cmd.run:</div><div class="line">    - name: chkconfig --add haproxy</div><div class="line">    - unless: chkconfig --list | grep haproxy</div><div class="line">    - require:</div><div class="line">        - file: /etc/init.d/haproxy</div></pre></td></tr></table></figure>
<h3 id="Haproxy-业务引用"><a href="#Haproxy-业务引用" class="headerlink" title="Haproxy 业务引用"></a>Haproxy 业务引用</h3><p>编写业务模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[root@master examples]<span class="comment"># mkdir -p /srv/salt/prod/cluster/files</span></div><div class="line"><span class="comment"># 创建 Haproxy 的最小化配置文件</span></div><div class="line"><span class="comment"># cat /srv/salt/prod/cluster/files/haproxy-outside.cfg</span></div><div class="line">global</div><div class="line">maxconn 100000</div><div class="line">chroot /usr/<span class="built_in">local</span>/haproxy</div><div class="line">uid 99</div><div class="line">gid 99</div><div class="line">daemon</div><div class="line">nbproc 1</div><div class="line">pidfile /usr/<span class="built_in">local</span>/haproxy/logs/haproxy.pid</div><div class="line"><span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>3 info</div><div class="line"></div><div class="line">defaults</div><div class="line">option http-keep-alive</div><div class="line">maxconn 100000</div><div class="line">mode http</div><div class="line">timeout connect 5000ms</div><div class="line">timeout client 50000ms</div><div class="line">timeout server 50000ms</div><div class="line"></div><div class="line">listen stats</div><div class="line">mode http</div><div class="line"><span class="built_in">bind</span> 0.0.0.0:8888</div><div class="line">stats <span class="built_in">enable</span></div><div class="line">stats uri /haproxy-status</div><div class="line">stats auth haproxy:saltstack</div><div class="line"></div><div class="line">frontend frontend_www_example_com</div><div class="line"><span class="built_in">bind</span> 10.0.0.11:80</div><div class="line">mode http</div><div class="line">option httplog</div><div class="line"><span class="built_in">log</span> global</div><div class="line">    default_backend backend_www_example_com</div><div class="line"></div><div class="line">backend backend_www_example_com</div><div class="line">option forwardfor header X-REAL-IP</div><div class="line">option httpchk HEAD / HTTP/1.0</div><div class="line">balance <span class="built_in">source</span></div><div class="line">server web-node1 192.168.56.11:8080 check inter 2000 rise 30 fall 15</div><div class="line">server web-node2 10.0.0.8:8080 check inter 2000 rise 30 fall 15</div></pre></td></tr></table></figure>
<p>Haproxy 的服务管理 sls :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@master examples]<span class="comment"># vim /srv/salt/prod/cluster/haproxy-outside.sls</span></div><div class="line">include:</div><div class="line">  - haproxy.install</div><div class="line"></div><div class="line">haproxy-service:</div><div class="line">  file.managed:</div><div class="line">    - name: /etc/haproxy/haproxy.cfg</div><div class="line">    - <span class="built_in">source</span>: salt://cluster/files/haproxy-outside.cfg</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - mode: 644</div><div class="line">  service.running:</div><div class="line">    - name: haproxy</div><div class="line">    - <span class="built_in">enable</span>: True</div><div class="line">    - reload: True</div><div class="line">    - require:</div><div class="line">      - cmd: haproxy-init</div><div class="line">    - watch:</div><div class="line">      - file: haproxy-service</div></pre></td></tr></table></figure>
<h3 id="执行-Haproxy-状态"><a href="#执行-Haproxy-状态" class="headerlink" title="执行 Haproxy 状态"></a>执行 Haproxy 状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master examples]<span class="comment"># vim /srv/salt/base/top.sls</span></div><div class="line">base:</div><div class="line">  <span class="string">'*'</span>:</div><div class="line">    - init.env_init</div><div class="line"></div><div class="line">prod:</div><div class="line">  <span class="string">'L@master,node2'</span>:</div><div class="line">    - cluster.haproxy-outside</div><div class="line"></div><div class="line">[root@master base]<span class="comment"># salt '*' state.highstate test=true</span></div><div class="line"><span class="comment"># 只对 prod 环境的 Haproxy 状态生效:</span></div><div class="line">[root@master base]<span class="comment"># salt -L 'master,node2' state.sls saltenv='prod' cluster.haproxy-outside test=true</span></div></pre></td></tr></table></figure>
<h3 id="查看-Haproxy-状态"><a href="#查看-Haproxy-状态" class="headerlink" title="查看 Haproxy 状态"></a>查看 Haproxy 状态</h3><p>用户名：haproxy 密码：saltstack<br><a href="http://10.0.0.7:8888/haproxy-status" target="_blank" rel="external">http://10.0.0.7:8888/haproxy-status</a><br><a href="http://10.0.0.8:8888/haproxy-status" target="_blank" rel="external">http://10.0.0.8:8888/haproxy-status</a>  </p>
<h2 id="Keepalived-Nginx-等其他业务，参照上述逻辑设计实现，不再赘述。"><a href="#Keepalived-Nginx-等其他业务，参照上述逻辑设计实现，不再赘述。" class="headerlink" title="Keepalived Nginx 等其他业务，参照上述逻辑设计实现，不再赘述。"></a>Keepalived Nginx 等其他业务，参照上述逻辑设计实现，不再赘述。</h2>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SaltStack/" rel="tag"># SaltStack</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/10/OpenStack/" rel="next" title="OpenStack">
                <i class="fa fa-chevron-left"></i> OpenStack
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/25/Zabbix监控体系部署/" rel="prev" title="Zabbix监控体系部署">
                Zabbix监控体系部署 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="qingyu.li" />
          <p class="site-author-name" itemprop="name">qingyu.li</p>
           
              <p class="site-description motion-element" itemprop="description">简单不先于复杂，而是在复杂之后</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://piandeng.com/" title="Piandeng" target="_blank">Piandeng</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-number">1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-the-following-commands-to-install-the-SaltStack-repository-and-key"><span class="nav-number">1.1.</span> <span class="nav-text">Run the following commands to install the SaltStack repository and key:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RedHat-Centos6"><span class="nav-number">1.1.1.</span> <span class="nav-text">RedHat/Centos6:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RedHat-Centos7"><span class="nav-number">1.1.2.</span> <span class="nav-text">RedHat/Centos7:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-yum-clean-expire-cache"><span class="nav-number">1.2.</span> <span class="nav-text">Run yum clean expire-cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-the-salt-minion-salt-master-or-other-Salt-components"><span class="nav-number">1.3.</span> <span class="nav-text">Install the salt-minion, salt-master, or other Salt components:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Automatically-start"><span class="nav-number">1.4.</span> <span class="nav-text">Automatically start</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他安装方式：salt-bootstrap-项目，多平台一键部署SaltStack环境"><span class="nav-number">1.5.</span> <span class="nav-text">其他安装方式：salt-bootstrap 项目，多平台一键部署SaltStack环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Master端安装："><span class="nav-number">1.5.1.</span> <span class="nav-text">Master端安装：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Minion端安装："><span class="nav-number">1.5.2.</span> <span class="nav-text">Minion端安装：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置"><span class="nav-number">2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#minion配置修改"><span class="nav-number">2.1.</span> <span class="nav-text">minion配置修改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#master服务端查看证书签证情况，并同意没有接受的签证请求"><span class="nav-number">2.2.</span> <span class="nav-text">master服务端查看证书签证情况，并同意没有接受的签证请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#执行第一条SaltStack命令"><span class="nav-number">2.3.</span> <span class="nav-text">执行第一条SaltStack命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一些常用命令"><span class="nav-number">2.4.</span> <span class="nav-text">一些常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#匹配方式"><span class="nav-number">2.4.1.</span> <span class="nav-text">匹配方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grains"><span class="nav-number">2.4.2.</span> <span class="nav-text">Grains</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pillar"><span class="nav-number">2.4.3.</span> <span class="nav-text">Pillar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Module"><span class="nav-number">2.4.4.</span> <span class="nav-text">Module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#States"><span class="nav-number">2.4.5.</span> <span class="nav-text">States</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实践案例"><span class="nav-number">3.</span> <span class="nav-text">实践案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境规划"><span class="nav-number">3.1.</span> <span class="nav-text">环境规划</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SaltStack环境设置"><span class="nav-number">3.1.1.</span> <span class="nav-text">SaltStack环境设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YAML-编写技巧"><span class="nav-number">3.2.</span> <span class="nav-text">YAML 编写技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是YAML"><span class="nav-number">3.2.1.</span> <span class="nav-text">什么是YAML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#规则："><span class="nav-number">3.2.2.</span> <span class="nav-text">规则：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jinja-使用技巧"><span class="nav-number">3.3.</span> <span class="nav-text">Jinja 使用技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是-Jinja"><span class="nav-number">3.3.1.</span> <span class="nav-text">什么是 Jinja</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何区分模版文件"><span class="nav-number">3.3.2.</span> <span class="nav-text">如何区分模版文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja-基本使用"><span class="nav-number">3.3.3.</span> <span class="nav-text">Jinja 基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja-逻辑关系"><span class="nav-number">3.3.4.</span> <span class="nav-text">Jinja 逻辑关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统初始化"><span class="nav-number">3.4.</span> <span class="nav-text">系统初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS-配置"><span class="nav-number">3.4.1.</span> <span class="nav-text">DNS 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Histroy-记录时间-操作记录加入到系统-message-日志"><span class="nav-number">3.4.2.</span> <span class="nav-text">Histroy 记录时间, 操作记录加入到系统 message 日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令操作审计"><span class="nav-number">3.4.3.</span> <span class="nav-text">命令操作审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内核参数优化"><span class="nav-number">3.4.4.</span> <span class="nav-text">内核参数优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#epel-仓库"><span class="nav-number">3.4.5.</span> <span class="nav-text">epel 仓库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zabbix-Agent"><span class="nav-number">3.4.6.</span> <span class="nav-text">Zabbix Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化环境引用"><span class="nav-number">3.4.7.</span> <span class="nav-text">初始化环境引用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Haproxy-配置管理"><span class="nav-number">3.5.</span> <span class="nav-text">Haproxy 配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pkg-配置"><span class="nav-number">3.5.1.</span> <span class="nav-text">pkg 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Haproxy-服务配置"><span class="nav-number">3.5.2.</span> <span class="nav-text">Haproxy 服务配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Haproxy-的安装-SLS"><span class="nav-number">3.5.3.</span> <span class="nav-text">Haproxy 的安装 SLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Haproxy-业务引用"><span class="nav-number">3.5.4.</span> <span class="nav-text">Haproxy 业务引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行-Haproxy-状态"><span class="nav-number">3.5.5.</span> <span class="nav-text">执行 Haproxy 状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看-Haproxy-状态"><span class="nav-number">3.5.6.</span> <span class="nav-text">查看 Haproxy 状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Keepalived-Nginx-等其他业务，参照上述逻辑设计实现，不再赘述。"><span class="nav-number">3.6.</span> <span class="nav-text">Keepalived Nginx 等其他业务，参照上述逻辑设计实现，不再赘述。</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qingyu.li</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("FqAp90PI86NxdOHOxWQ0VrFS-gzGzoHsz", "GKvXMFDzPRF3a0w9BaOEx52z");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



  

</body>
</html>
